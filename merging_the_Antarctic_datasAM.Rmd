---
title: "R Notebook"
output: html_notebook
---


```{r libraries, message = FALSE}

library(phyloseq)
library(dplyr) # group_by
library("openxlsx") # export to Excel
library(readxl) # open to Excel

```

# Part 1A: Phyloseq object that contains AGR PO_2022 data

No. taxa = 20688
No. samples = 482
No. variables = 84


Load modified OTU table and Sample_data files

* BV: Changed column names in AGR file to coincide with NIWA df.
* BV: Added a column with Row_names to match NIWA df.

No. samples = 482
No. variables = 24 (first column is sample names matching OTU table)

## Check water mass of sample MS526 - TAN0909

```{r}

# Load modified OTU table
OTU_ex.SW <- read_excel("C:/Belli/Files/202203_PO2022_OTU table_AGR_mod BV.xlsx")
OTU_ex.SW <- as.data.frame(OTU_ex.SW)

# ASVs as row.names. Delete the column
row.names(OTU_ex.SW) <- OTU_ex.SW$OTU
OTU_ex.SW$OTU <- NULL
# Convert to matrix
OTU_mat.SW <- as.matrix(OTU_ex.SW)

# Load modified Sample_data
samples_ex.SW <- read_excel("C:/Belli/Files/202203_PO2022_metadata_AGR_mod BV.xlsx")
samples_ex.SW <- as.data.frame(samples_ex.SW)

#Load tax_table. I had to modidy the script as I didnÂ´t have the  "intomob123_phyloseq_15March2022_RANKED_seawater.rds"
TAX.SW <- read_excel("C:/Belli/Files/202203_PO2022_TAX table_AGR.xlsx")
TAX_df.SW <- as.data.frame(TAX.SW)
rownames(TAX_df.SW) <- TAX_df.SW$OTU

# Convert to matrix
TAX.SW <- as.matrix(TAX_df.SW)

```

I need to import some lat long information from the samples_df_MLD_March2020.xlsx file
```{r}

# Read Excel file
samples_df <- read_excel("C:/Anna_Maria_IEO/thesis/tables/cruises_detailed_excels/samples_df_MLD_March2020.xlsx")

# Select only the needed columns from samples_df
samples_latlong <- samples_df %>% select(Sample_ID, Lat, Long)

# Merge the two datasets based on Sample_ID
samples_ex.SW  <- samples_ex.SW %>% 
  left_join(samples_latlong, by = "Sample_ID")

# Sample names as row.names. Delete the column
row.names(samples_ex.SW) <- samples_ex.SW$Row_names
samples_ex.SW$Row_names <- NULL

```

```{r}
# Convert to phyloseq

OTU_mod.SW = otu_table(OTU_mat.SW, taxa_are_rows = TRUE)
samples_mod.SW = sample_data(samples_ex.SW)
TAX_SW = tax_table(TAX.SW)

```

Create a phyloseq object with modified AGR PO_2022 data
* Keep only OTUs present

No. Taxa: 18008
No. samples: 482
No. variables: 24

```{r}

PO.mod = phyloseq(OTU_mod.SW, TAX_SW, samples_mod.SW)

PO.mod <- PO.mod %>% filter_taxa(function(x) sum(x) > 0, TRUE)

PO.mod

unique(get_variable(PO.mod, "Cruise.TAN"))

metadataPO <- as.data.frame(sample_data(PO.mod))

tax_PO <- as.data.frame(tax_table(PO.mod))
   
```
Name of each cruise in Sample_data

```{r}
unique(get_variable(PO.mod, "Cruise.TAN"))
```

# Part 1B: Open the phyloseq object that contains all NIWA's projects

No. taxa = 86603
No. samples = 1926
No. variables = 72

```{r pressure, echo=FALSE}

nz <- readRDS("C:/Belli/Files/NIWA_physeq_object_with_metadata.rds")

nz

```

Name of each project in Sample_data

```{r}
unique(get_variable(nz, "Project"))
```

Split ps object to obtain the OTU table and TAX table

* Data has been added to Sample_data, so a new ps object needs to be created.

```{r}

# Get OTU table and TAX table
OTU_NI = otu_table(nz)
TAX_NI = tax_table(nz)

# Convert to data.frame
OTU_df.NI <- data.frame(OTU_NI)
TAX_df.NI <- data.frame(OTU = taxa_names(nz), TAX_NI)

# Export to Excel
#write.xlsx(TAX_df.NI, "202412_final_Taxa NIWA.xlsx")

```

Load modified Sample names, TAX_table and Sample_data file

* OTU_table: Changed names of Sediment Cores and Sediment Trap samples

* TAX_table: Omitted columns to coincide with AGR TAX_table

* Sample_data:
- BV: Filled blank cells in "Area", "Water mass", "Date", and "Season" 
- BV: Changed "Sample Type" for a shorter version. Original names in C74
- BV: Added columns Year, Month, Season (filled based on files sent by AGR, 20150130_Biophysical Mooring Data Complete)

No. samples = 1926
No. variables = 77 (first column is sample names matching OTU table)

```{r}

# Load modified sample names 
Names_NI <- read_excel("C:/Belli/Files/20241110_Sample names_mod BV.xlsx", sheet = "OTU")
# dup <- duplicated(Names$Sample_id)

# OTU_table -> Change variable names in OTU_table df
rownames(OTU_df.NI) <- Names_NI$Sample_id
# Convert to matrix
OTU_mat.NI <- as.matrix(OTU_df.NI)


# Load modified Tax_table
TAX_ex.NI <- read_excel("C:/Belli/Files/202412_final_Taxa NIWA_mod BV.xlsx")
TAX_ex.NI <- as.data.frame(TAX_ex.NI)

# ASVs as row.names. Delete the column
row.names(TAX_ex.NI) <- TAX_ex.NI$OTU
TAX_ex.NI$OTU <- NULL
# Convert to matrix
TAX_mat.NI <- as.matrix(TAX_ex.NI)

# Load modified Sample_data including the datas that I already filled up for the Antarctic cruises
samples_ex.NI <- read_excel("C:/Belli/Files/20241110_final_metadata_AGR_mod BV.xlsx")

# Convert to data.frame
samples_ex.NI <- as.data.frame(samples_ex.NI)

# Delete empty rows (no idea why)
samples_ex.NI <- samples_ex.NI[!(is.na(samples_ex.NI$Row_names)), ]
# samples_ex.NI <- samples_ex.NI[samples_ex.NI$Row_names != "", ] # csv

# Sample_ID as row.names. Remove the column with sample names
row.names(samples_ex.NI) <- samples_ex.NI$Row_names
#samples_ex.NI$Row_names <- NULL

```
Select only the variables to be used in the paper = 26 variables
* Change variable names to a shorter version

```{r}

samples_Sel <- samples_ex.NI %>%
  rename(Water_mass = Water_mass.TS,
         Biom_Cil_Total = Total_Ciliate_Biomas, Biom_Tin = Tintin_Biomass, 
         Biom_Nlor = Non_lor_Biomass, 
         POC = POC_ave, PON = PON_ave, PP = PP_ave, PN = PN_ave)

samples_Sel <- samples_Sel %>% 
  select(Sample_ID, Cruise.TAN, Project, Area,Subarea, Water_mass, U_Cast,
         Date, Year, Month, Season, Depth, Depth_Zone, Sample_Type, 
         Temp, Sal, Biom_Cil_Total, Biom_Tin, Biom_Nlor, 
         POC, PON, PP, PN, NO3, DRSi, DRP, Chla_total,Chla_02,Chla_2,Chla_20,Lat,Long) 

```

Convert to phyloseq

```{r}

# Convert to phyloseq
OTU_mod.NI = otu_table(OTU_mat.NI, taxa_are_rows = FALSE)
TAX_mod.NI = tax_table(TAX_mat.NI)
samples_mod.NI = sample_data(samples_Sel)


```

Create temporal phyloseq objects until getting the final one

* t1 -> with updated sample_data
No. Taxa: 86603
No. samples: 1926
No. variables: 32

```{r}

t1 = phyloseq(OTU_mod.NI, TAX_mod.NI, samples_mod.NI)

t1
x <- as.data.frame(sample_data(t1))
x1 <- subset_samples(t1, Project != "BiophysMoorings")
x2 <- as.data.frame(sample_data(x1))
unique(get_variable(x2, "Cruise.TAN"))

tax_NI <- as.data.frame(tax_table(t1))
   
unique(get_variable(t1, "Cruise.TAN"))
```

# Part 1C: Merge the phyloseq objects -> AGR PO_2022 ,NIWA

* Samples in NIWA = 1926

* Samples in PO_2022 = 482
- Same as in NIWA = 61
- New = 2347

* Expected total Samples in combined phyloseq object = 2347

No. Taxa: 104611 .
No. samples: 2347 
No. variables: 33

```{r}

ps <- merge_phyloseq(t1, PO.mod)

ps

```

Cruises, Sample types, and Sample names in new ps object

```{r}
# Cruise names
unique(get_variable(ps, "Cruise.TAN"))

# Sample types
unique(get_variable(ps, "Sample_Type"))

# Sample names
unique(get_variable(ps, "Sample_ID"))
# sample_names(ps)

```



```{r}
# Extract the OTU table, tax table, and metadata
otu_table <- as.data.frame(otu_table(ps))
tax_table <- as.data.frame(tax_table(ps))
metadata <- as.data.frame(sample_data(ps))

otu_table <- cbind(samples = rownames(otu_table), otu_table)

metadata <- as.data.frame(sample_data(ps))

# Apply conversion to all columns except "area"
metadata[] <- lapply(names(metadata), function(col) {
  x <- metadata[[col]]
  
  if (col == "Area") return(x)  # Skip conversion for "area"
  
  if (is.factor(x)) x <- as.character(x)
  if (is.character(x)) {
    suppressWarnings(x_num <- as.numeric(x))
    if (sum(!is.na(x_num)) > 0) return(x_num) else return(x)
  } else {
    return(x)
  }
})

# Preserve column names after lapply (since names get lost when using lapply over names)
metadata <- as.data.frame(metadata)
colnames(metadata) <- names(sample_data(ps))


# Combine all the data into a list
data_list <- list(
  "OTU Table" = otu_table,
  "Tax Table" = tax_table,
  "Metadata" = metadata
)


# Write the list to an Excel file
#write.xlsx(metadata, "C:/Anna_Maria_IEO/thesis/tables/phyloseq_export_ps_AMmetadata.xlsx")

```


Save the ps object with updated sample_data to be used in the paper

```{r}

saveRDS(ps, file = "C:/Anna_Maria_IEO/thesis/tables/Anna_Maria_merging_the_data.rds")

```


