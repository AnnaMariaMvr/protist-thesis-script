
#Libraries
```{r cars}
library(stringr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(readr)
library("treemapify")
library(treemap)
library("Cairo")
library("readxl")
library("openxlsx")
library("gplots")
library(forcats)
library(mgcv)
library(phyloseq)
library(vegan)
library(magrittr)
library(tibble)
library(tidyverse)
#data(GlobalPatterns)
library(RColorBrewer)
library(data.table)
library(GGally)
library(corrplot)
library(ggplot2)
library(cowplot)
library(grid)
library(Cairo)
library(microbiome)
library(microViz)

```
First, importing the clean phyloseq

No. taxa = 104611
No. samples = 2082
No. variables = 34
```{r}
# Load cleaned phyloseq object
ps_cleaned <- readRDS("C:/Anna_Maria_IEO/thesis/tables/Anna_Maria_cleaned_phyloseq.rds")

# Remove samples from unwanted project
ps_cleaned <- subset_samples(ps_cleaned, Project != "BiophysMoorings")

# Remove problematic samples from PO2022 based on previously identified sample differences
samples_po_only <- setdiff(sample_names(PO.mod), sample_names(t1))
ps_cleaned <- subset_samples(ps_cleaned, !(sample_names(ps_cleaned) %in% samples_po_only))

# Drop OTUs not present after filtering samples
ps_cleaned <- prune_taxa(taxa_sums(ps_cleaned) > 0, ps_cleaned)

# Remove OTUs that only exist in PO.mod but not in t1 (taxonomy fix)
otus_po_only <- setdiff(taxa_names(PO.mod), taxa_names(t1))
ps_cleaned <- prune_taxa(!(taxa_names(ps_cleaned) %in% otus_po_only), ps_cleaned)

ps_cleaned
```

Filtration based on Taxonomy - for PROTISTS
Filtration: removing Biostat,TAN1708 and SEA0201 cruises and keeping only Seawater samples.

ps_protist_heter
phyloseq-class experiment-level object
otu_table()   OTU Table:         [ 13272 taxa and 671 samples ]
sample_data() Sample Data:       [ 671 samples by 40 sample variables ]
tax_table()   Taxonomy Table:    [ 13272 taxa by 12 taxonomic ranks ]
```{r pressure, echo=FALSE}
  # Keep only protist taxa, remove Metazoa and Fungi, unwanted cruises, and non-seawater samples(I am removing TAN1604 as I only had 6 samples in the NIWA excel)
ps_protist <- ps_cleaned %>%
  subset_taxa(!(Division %in% c("Metazoa", "Fungi"))) %>%
  subset_samples(!(Cruise.TAN %in% c("Biostat", "TAN1708","TAN1604", "SEA0201"))) %>%
  subset_samples(Sample_Type == "SW") %>%
  subset_samples(!(Sampling_Type %in% c("underway", "Underway", "Incubation"))) %>%
  subset_taxa(!is.na(trophic_mode))  # Keep only taxa with known trophic mode


unique(as.vector(tax_table(ps_protist)[, "trophic_mode"])) #Checking if the it contains all the types of protists
unique(get_variable(ps_protist, "Sample_Type"))            #Checking that we only have SW
unique(get_variable(ps_protist, "Sampling_Type"))          #Checking that we don´t have underway
unique(get_variable(ps_protist, "Water_mass"))             #Checking the water masses
unique(get_variable(ps_protist, "Cruise.TAN"))             #Checking the Cruises

# Keep only heterotrophic and mixotrophic protists
ps_protist_heter <- subset_taxa(ps_protist, trophic_mode %in% c("heterotrophic", "mixotrophic"))

ps_protist_heter

# Remove Syndiniales from heterotrophs (they are often parasitic and hard to interpret)
ps_protist_Synd <- subset_taxa(ps_protist_heter, !(trophic_mode_2 %in% c("Syndiniales")))

# Keep only photosynthetic and mixotrophic protists
ps_protist_autot <- subset_taxa(ps_protist, trophic_mode %in% c("photosynthetic", "mixotrophic"))

 
unique(as.vector(tax_table(ps_protist_heter)[, "trophic_mode"])) #Checking if only have heterotrophs
unique(get_variable(ps_protist_heter, "Cruise.TAN"))             #Checking the Cruises
unique(get_variable(ps_protist_heter, "Sample_Type"))            #Checking that we only have SW
unique(get_variable(ps_protist_heter, "Sampling_Type"))          #Checking that we don´t have underway
unique(get_variable(ps_protist_heter, "Water_mass"))             #Checking the water masses
unique(get_variable(ps_protist_heter, "Project"))
unique(as.vector(tax_table(ps_protist_autot)[, "trophic_mode"])) #Checking if the it contains only autotrophs

tax_autottest <- as.data.frame(tax_table(ps_protist_autot))
```

This is Andres code from: https://github.com/agutierrez2001/Catalyst_Biogeography/blob/main/NZ_MetaB_Paper_ALLPROTIST.Rmd

ONLY HETEROTROPHS
# # First - 
# ## Standardize abundances to the median sequencing depth
Goal: Normalize counts so that all samples are scaled to the same sequencing depth — the median.
(sample_sums(ps) gets total reads per sample, transform_sample_counts() applies your custom normalization function to each sample and round() is used to keep counts as integers (optional but common)).
```{r}
#HETEROTROPHS PROTISTS 
# Normalize OTU counts to the median sequencing depth across samples
ps_protist_heter_median <- median(sample_sums(ps_protist_heter))
normalize_protist_heter_median <- function(x, t = ps_protist_heter_median) round(t * (x / sum(x)))

# Apply normalization
ps_protist_heter_std <- transform_sample_counts(ps_protist_heter, normalize_protist_heter_median)

unique(as.vector(tax_table(ps_protist_heter_std)[, "trophic_mode"]))

```

### CLASS LEVEL STACK BAR ANALYSIS - SAMPLE WISE
## ANALYSIS OF RELATIVE ABUNDANCES - %
##Calculate statistics of group specific relative abundances 

```{r pressure, echo=FALSE}

# Keep only samples from the euphotic zone (photic surface layer)
ps_protist_euphotic_heter <- subset_samples(ps_protist_heter_std, photic_zone == "Euphotic")

#####################################################################
# Replace NA values in the OTU table with 0 to avoid downstream errors
otu_table(ps_protist_euphotic_heter)[is.na(otu_table(ps_protist_euphotic_heter))] <- 0

anyNA(otu_table(ps_protist_euphotic_heter))  # should return FALSE

####################################################################

# Aggregate data to Class level (merge OTUs belonging to the same Class)
# CLASS
#tax_glom() merges taxa (ASVs/OTUs) at a higher taxonomic level — here, you're grouping by "Class". If multiple ASVs belong to the same Class, they get summed into one row. The new phyloseq object now has fewer taxa, each representing a Class, not individual ASVs.
#Replace all Nas with 0 in phyloseq
 
ps_protist_heter_class <- tax_glom(ps_protist_euphotic_heter, taxrank = "Class")

plot(sort(taxa_sums(ps_protist_heter_class), TRUE) )
get_taxa_unique(ps_protist_heter_class, "Class")


#Checking how many samples I have per water sample
table(sample_data(ps_protist_euphotic_heter)$Water_mass)

#Antarctic       SAW       STF       STW 
#      231       111        35       170 

```
## Third - Standardize to relative abundances 
```{r pressure, echo=FALSE}
# Transform to relative abundance for percentage-based interpretation
ps_protist_heter_class.rel <- transform_sample_counts(ps_protist_heter_class, function(OTU) OTU * 100 / sum(OTU))

# Replace any NaNs with 0
#During normalization, we did: 
#ps_rel <-transform_sample_counts(ps_protist_heter_class, function(OTU) OTU*100/sum(OTU))
#That works only if sum(OTU) > 0 — otherwise, it returns NaN when dividing by 0.
#So if any samples were completely zero (no reads), then those taxa end up with NaN values.
 
otu <- otu_table(ps_protist_heter_class.rel)
otu[is.nan(otu)] <- 0 #Finds all NaN values in the OTU table and replaces them with 0, so they no longer cause                              errors or strange behavior in downstream analysis.
otu_table(ps_protist_heter_class.rel) <- otu #updating phyloseq with the fixed values.

```
## Select main classes of interest  -  most abundant classes
```{r pressure, echo=FALSE}
# Sum total relative abundance for each Class and select top 12 most abundant
protist.heter.class.sum <- tapply(taxa_sums(ps_protist_heter_class.rel), 
                                  tax_table(ps_protist_heter_class.rel)[, "Class"], sum, na.rm = TRUE)

#Sorts the classes from most to least abundant.Picks out the top 12 most abundant Class names.

top12classheter <- names(sort(protist.heter.class.sum, TRUE))[1:12]

# Replace classes not in the top 12 with "Other"
#prune_taxa() keeps only the taxa (i.e., Classes) that are in your top 12 list. This filters the phyloseq object to just those top 12 Classes — nice and tidy!
  
# Extract tax_table as a data.frame
tax_df <- as.data.frame(tax_table(ps_protist_heter_class.rel))

# Replace classes that are not in the top 12 with "Other"
tax_df$Class <- ifelse(tax_df$Class %in% top12classheter, tax_df$Class, "Other")

# Set it back into the phyloseq object
tax_table(ps_protist_heter_class.rel) <- tax_table(as.matrix(tax_df))

# Final phyloseq object for top 12 classes
ps_protist_heter_class.top12.abund <- ps_protist_heter_class.rel

ps_protist_heter_class.top12.abund = ps_protist_heter_class.rel

ps_protist_heter_class.top12.abund
  
  #sort(protist.heter.class.sum, TRUE)[1:15]

```

# Colors for plotting taxonomy

```{r pressure, echo=FALSE}

# Load color scheme from Excel and prepare named vectors for plotting
classes_division <- read_excel("C:/Anna_Maria_IEO/thesis/tables/Color_division.xlsx")

classes_division$color_hex_class <- col2hex(classes_division$color_class)
class_color_class <- structure(as.character(classes_division$color_hex_class),
                               .Names = as.character(classes_division$class))
class_color_class["Other"] <- "#BDBDBD"  # grey for 'Other'


```

## Make LONG FORMAT dataframe for plotting
# PROTIST - SYND
```{r pressure, echo=FALSE}

# Reshape OTU table into long format for ggplot2
otu_dfheter <- as.data.frame(otu_table(ps_protist_heter_class.top12.abund)) %>%
  rownames_to_column(var = "file_code") %>%
  pivot_longer(cols = -file_code, names_to = "OTUNumber", values_to = "n_reads") %>%
  filter(!is.na(n_reads))

# Join taxonomic and metadata information
taxo_dfheter <- as.data.frame(tax_table(ps_protist_heter_class.top12.abund)) %>%
  rownames_to_column("OTUNumber")
otu_dfheter <- left_join(taxo_dfheter, otu_dfheter)

metadata_dfheter <- data.frame(sample_data(ps_protist_heter_class.top12.abund)) %>%
  rownames_to_column("file_code")
otu_dfheter <- left_join(otu_dfheter, metadata_dfheter, by = "file_code")

# Merge color assignments
class_df_Top12_protist_heter <- left_join(otu_dfheter, classes_division, by = c("Class" = "class"))

# Remove under-sampled cruises. After removing the PO2022 samples , I notice that I have some samples from some cruises that are just a few.
class_df_Top12_protist_heter <- class_df_Top12_protist_heter %>%
  filter(!(Cruise.TAN %in% c("TAN0902", "TAN0909", "TAN1006", "TAN1103", "TAN1113", "TAN1204", "TAN1604")))
      
```

Relative abundances
```{r pressure, echo=FALSE}

# Loop through each water mass and generate relative abundance barplots and treemaps
water_masses <- unique(class_df_Top12_protist_heter$Water_mass)

for (wm in water_masses) {
  
  df_watermass <- class_df_Top12_protist_heter %>% filter(Water_mass == wm)

  class_stats <- df_watermass %>%
    group_by(Class) %>%
    add_tally() %>%
    summarise(
      median = median(n_reads),
      mean = mean(n_reads),
      sd = sd(n_reads),
      n = mean(n)
    ) %>%
    arrange(-mean)

  class_stats_col <- left_join(class_stats, classes_division, by = c("Class" = "class"))
  color_class <- setNames(class_stats_col$color_hex_class, class_stats_col$Class)
  color_class["Other"] <- "#BDBDBD"
  class_stats_col$Class <- reorder(class_stats_col$Class, -class_stats_col$mean)

  # Barplot PDF
  filename <- paste0("Protist_heterrophs_", wm, "_REL_STATS_BARPLOT.pdf")
  CairoPDF(file = filename, width = 8, height = 6)
  print(
    ggplot(class_stats_col, aes(x = Class, y = mean, fill = Class)) +
      geom_bar(stat = "identity", width = 0.9) +
      scale_fill_manual(values = color_class) +
      ggtitle(paste("Protist - Euphotic - MEAN -", wm)) +
      xlab("") +
      ylab("% Relative abundance") +
      geom_errorbar(aes(ymin = mean, ymax = mean + sd), width = 0.1, size = 0.1) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 6))
  )
  dev.off()

  # Treemap PDF
  treemap_data <- class_stats_col %>%
    mutate(label = paste0(Class, "\n", round(mean, 1), "%"))

  treemap_filename <- paste0("Protist_heterrophs_", wm, "_REL_STATS_TREEMAP.pdf")
  CairoPDF(file = treemap_filename, width = 8, height = 6)
  treemap(
    treemap_data,
    index = "label",
    vSize = "mean",
    vColor = "Class",
    type = "categorical",
    palette = color_class,
    title = paste("Protist - Euphotic - Treemap -", wm),
    fontsize.labels = 8,
    border.col = "white"
  )
  dev.off()
}

```

I want to extract the legend for the text
```{r}

# Prepare dummy data to include all classes
all_classes <- unique(class_df_Top12_protist_heter$Class)
legend_df <- data.frame(
  Sample = "Dummy",
  Abundance = 1,
  Class = all_classes
)

# Color map (make sure it's complete)
color_class <- setNames(classes_division$color_hex_class, classes_division$class)
color_class["Other"] <- "#BDBDBD"

# Dummy plot for legend
legend_plot <- ggplot(legend_df, aes(x = Sample, y = Abundance, fill = Class)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = color_class) +
  theme_void() +
  guides(fill = guide_legend(ncol = 1)) +  # Single column
  theme(
    legend.position = "right",
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    legend.key.height = unit(1.2, "cm")  # Increase vertical space here
  )

# Extract legend only
legend_only <- cowplot::get_legend(legend_plot)

# Save as PNG with transparent background
CairoPNG("Legend_only_protist_classes_wide_spacing.png", width = 400, height = 1000)  # Increase height as needed
grid.newpage()
grid.draw(legend_only)
dev.off()


```
### SO FOR NOW I NEED TO PLOT WATER MASSES INDEPENDENTLY - One water mass at a time
Heterotrophics
## SUM of reads - It rseults in the same ranking as using the mean but with different absolute numbers

### MOST ABUNDANT SPECIES 
This is Andres code from: https://github.com/agutierrez2001/Catalyst_Biogeography/blob/main/NZ_MetaB_Paper_ALLPROTIST.Rmd
# PROTIST - HETEROTROPHS
# Select MOST ABUNDANT SPECIES AND PRUNE FOR NEW PS OBJECT THAT CAN BE TRANSFORMED

```{r pressure, echo=FALSE}
ps_protist_euphotic_heter <- subset_samples(ps_protist_heter_std, photic_zone == "Euphotic")

# CLASS - I was getting an error "Error in merge_taxa.indices.internal(x, eqtaxa, archetype) : invalid archetype provided" since I had some Nas in the otu table. I am removing them in order to work.
#####################################################################
  otu_table(ps_protist_euphotic_heter)[is.na(otu_table(ps_protist_euphotic_heter))] <- 0
  anyNA(otu_table(ps_protist_euphotic_heter))  # should return FALSE
####################################################################
  #NArm = F to avoid discarding ASVs without a genus annotation - if not, your relative abundances will not be correct.
# Second - agglomerate the sequencing depth normalized OTU table 
# CLASS
#tax_glom() merges taxa (ASVs/OTUs) at a higher taxonomic level — here, you're grouping by "Class". If multiple ASVs belong to the same Class, they get summed into one row. The new phyloseq object now has fewer taxa, each representing a Class, not individual ASVs.  
ps_protist_species_het <- tax_glom(ps_protist_euphotic_heter, taxrank = "Species",NArm = FALSE)

plot(sort(taxa_sums(ps_protist_species_het), TRUE) )
get_taxa_unique(ps_protist_species_het, "Species")

```
## Third - Standardize to relative abundances 
```{r pressure, echo=FALSE}

ps_protist_species_het.rel = transform_sample_counts(ps_protist_species_het, function(OTU) OTU*100/sum(OTU))

```
### select Top 100 PROTIST-SYND classes of interest based on abundance
```{r}
#During normalization, we did: 
#ps_rel <-transform_sample_counts(ps_protist_species, function(OTU) OTU*100/sum(OTU))
#That works only if sum(OTU) > 0 — otherwise, it returns NaN when dividing by 0.
#So if any samples were completely zero (no reads), then those taxa end up with NaN values.
 

otu <- otu_table(ps_protist_species_het.rel)
otu[is.nan(otu)] <- 0 #Finds all NaN values in the OTU table and replaces them with 0, so they no longer cause                            errors or strange behavior in downstream analysis.
otu_table(ps_protist_species_het.rel) <- otu #updating k,in phyloseq with the fixed values.



    ### most abundant classes
 species.sum_protist = tapply(taxa_sums(ps_protist_species_het.rel), tax_table(ps_protist_species_het.rel)[, "Species"], mean, na.rm=TRUE)
  top100species_protist = names(sort(species.sum_protist, TRUE))[1:100]
  Top100species_protist = prune_taxa((tax_table(ps_protist_species_het.rel)[, "Species"] %in% top100species_protist), ps_protist_species_het.rel)
  Top100species_protist
  
Species_names_protist = data.frame(Species_reads = sort(taxa_sums(Top100species_protist), TRUE), sorted = 1:ntaxa(Top100species_protist), Species = tax_table(Top100species_protist)[, "Species" ])

#write.xlsx(Species_names_protist , file = "Tables/Species_abundance_protist_ALL_MEAN_top100_March2022.xlsx")

```
# Dataframe and wide to long transformation of phyloseq object - 
```{r pressure, echo=FALSE}

otu_df_protist_heter <- as.data.frame(Top100species_protist@otu_table@.Data, stringsAsFactors = FALSE) %>%
  rownames_to_column(var = "file_code") %>%  # rownames are sample IDs now
  pivot_longer(
    cols = -file_code,
    names_to = "OTUNumber",
    values_to = "n_reads",
    values_drop_na = TRUE
  ) %>%
  filter(n_reads != 0, !is.na(n_reads))

  # See https://github.com/joey711/phyloseq/issues/983
    taxo_df_protist <- as.data.frame(Top100species_protist@tax_table@.Data, stringsAsFactors = FALSE) %>%
      rownames_to_column(var = "OTUNumber")

    otu_df_protist_heter <- left_join(taxo_df_protist, otu_df_protist_heter)

    metadata_df <- data.frame(sample_data(Top100species_protist)) %>%
      rownames_to_column(var = "file_code")

    otu_df_protist_heter <- left_join(otu_df_protist_heter, metadata_df, by = c("file_code"))
     
    unique(get_variable(otu_df_protist_heter, "Class"))
    
    OTU_abund_top100_protist_eu  <-left_join(otu_df_protist_heter, classes_division, by=c("Class"= "class"))
    
    unique(get_variable(OTU_abund_top100_protist_eu, "Class"))

```


### Select most abundant OTUs per WATER MASSES using dplyr - EUPHOTIC

## TOP 100 species ps object - OPTION A for meaningful average abundance values

```{r, fig.height=8, fig.width=8}
OTU_abund_top100_protist_eu  <-   OTU_abund_top100_protist_eu  %>%
  group_by(OTUNumber, Water_mass) %>%
  add_tally(name = "n") %>%
  mutate(mean_OTU = mean(n_reads, na.rm=TRUE), median_OTU = median(n_reads, na.rm=TRUE), Total_OTU = sum(n_reads, na.rm = TRUE), n_samples = mean(n)) %>%
  select(OTUNumber:Water_mass, Sample_Type, Supergroup:Total_OTU) %>%
  arrange(Water_mass, -Total_OTU) %>%
  unite(OTU_water, OTUNumber, Water_mass, remove = FALSE) %>% # to allow selecting for distinct OTUs
  unite(OTU_genus, OTUNumber, Genus, remove = FALSE) %>%
  unite(OTU_species, OTUNumber, Species, remove = FALSE)


## Select most abundant OTUs for plotting SUM TOTAL read abundance values
OTU_abund_top100_protist_eu_SUM <- OTU_abund_top100_protist_eu %>%
  distinct(OTU_water, .keep_all = TRUE) %>%
  arrange(Water_mass, -Total_OTU) %>%
   group_by(Water_mass) %>% 
   top_n(20,Total_OTU)

unique(get_variable(OTU_abund_top100_protist_eu_SUM, "Class"))
```


```{r}
# color coding # Water mass - SUM or MEAN
color_class1 <- as.character(OTU_abund_top100_protist_eu_SUM$color_hex_class)
names(color_class1) <- as.character(OTU_abund_top100_protist_eu_SUM$Class)
OTU_abund_top100_protist_eu_SUM$OTU_species = with(OTU_abund_top100_protist_eu_SUM, reorder(OTU_species, Total_OTU))

# Loop over unique water masses
for (wm in unique(OTU_abund_top100_protist_eu_SUM$Water_mass)) {
  
  Top_otu_order <- OTU_abund_top100_protist_eu_SUM %>%
    filter(Water_mass == wm) %>%
    mutate(name = fct_reorder(OTU_species, Total_OTU))
  
  g <- ggplot(Top_otu_order, aes(x = name, y = Total_OTU, fill = Class)) +
    geom_bar(stat = "identity", width = 0.95) +
    coord_flip() +
    scale_fill_manual(values = color_class1) +
    xlab("") +
    theme_bw() +
    theme(
        aspect.ratio = 2/1,
        axis.text.x = element_text(angle = 0, hjust = 1, size = 12),
        axis.text.y = element_text(angle = 0, hjust = 1, size = 12),
        legend.position = "none"  # Removes legend
    ) +
    ggtitle(paste("Protist - Heter - Euphotic -", wm, "- SUM")) +
    ylab("Sum OTU - Sequencing depth standardized abundance")

  # Save the plot
  ggsave(filename = paste0("Protist_heter_euphotic_top20_", wm, "_SUM.pdf"),
         plot = g, dpi = 300, width = 8, height = 16, scale = 1.2)
}
```


NOW EACH CRUISE SEPERATELY
```{r}

# color coding # Water mass - MEAN
color_class_heter <- as.character(class_df_Top12_protist_heter$color_hex_class)
names(color_class_heter) <- as.character(class_df_Top12_protist_heter$Class)
class_df_Top12_protist_heter$OTU_species = with(class_df_Top12_protist_heter, reorder(Class, n_reads))

# Step 1: Filter and prep the data
selected_cruises <- c("TAN1802")
class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    CTD_number = as.character(CTD_number),
    Depth = as.character(Depth),
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # keep bar order consistent
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(CTD_number), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "CTD number by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - 1802") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_1802.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")

##


selected_cruises <- c("TAN1802")
desired_day_order <- paste("Day", 1:17)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    Day = gsub("\\s+", " ", trimws(Day)),  # Remove extra spaces
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%
  mutate(
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))
  )


# Step 2: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  deframe()

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1802") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selectedSAMPDEPTH_TAN1802.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------

# Step 1: Filter and prep the data
selected_cruises <- c("TAN1901")
class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    CTD_number = as.character(CTD_number),
    Depth = as.character(Depth),
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # keep bar order consistent
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(CTD_number), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "CTD number by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - 1901") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_1901.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")

##


selected_cruises <- c("TAN1901")
desired_day_order <- paste("Day", 1:31)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    Day = gsub("\\s+", " ", trimws(Day)),  # Remove extra spaces
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%
  mutate(
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))
  )


# Step 2: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  deframe()

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12,angle = 90, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1901") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selectedSAMPDEPTH_TAN1901.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------

# Step 1: Filter and prep the data
selected_cruises <- c("TAN2101")
class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    CTD_number = as.character(CTD_number),
    Depth = as.character(Depth),
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # keep bar order consistent
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
distinct(Sample_ID, Depth) %>%
arrange(Sample_ID) %>%
 deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(CTD_number), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "CTD number by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - 2101") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_2101.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")

##
selected_cruises <- c("TAN2101")
desired_day_order <- paste("Day", 1:31)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    Day = gsub("\\s+", " ", trimws(Day)),  # Remove extra spaces
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%
  mutate(
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))
  )


# Step 2: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  deframe()

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12,angle = 90, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN2101") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selectedSAMPDEPTH_TAN2101.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------

# Step 1: Filter and prep the data
selected_cruises <- c("KAH1303")
class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    CTD_number = as.character(Day),
    Depth = as.character(Depth),
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # keep bar order consistent
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - KAH1303") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_KAH1303.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------

# Step 1: Filter and prep the data
selected_cruises <- c("TAN1203")
class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    CTD_number = as.character(Day),
    Depth = as.character(Depth),
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # keep bar order consistent
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]


# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  #scale_x_discrete(labels = Sample_ID) +  # show Sample_ID instead of depth because I only have the nominal depth.
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1203") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_TAN1203.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------

# Step 1: Filter and prep the data
selected_cruises <- c("TAN1212")
desired_day_order <- paste("Day", 1:16)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
   Day = gsub("\\s+", " ", trimws(Day)),  # Remove extra spaces
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%
  mutate(Sample_ID = factor(Sample_ID, levels = unique(Sample_ID)))

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]


# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  #scale_x_discrete(labels = Sample_ID) +  # show Sample_ID instead of depth because I only have the nominal depth.
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1212") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_TAN1212.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------

# Step 1: Filter and prep the data
selected_cruises <- c("TAN1516")
desired_day_order <- paste("Day", 1:17)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%  # arrange by day and then sample
  mutate(
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # reorder Sample_IDs to reflect Day order
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]


# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  #scale_x_discrete(labels = Sample_ID) +  # show Sample_ID instead of depth because I only have the nominal depth.
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1516") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_TAN1516.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------


# Step 1: Filter and prep the data
selected_cruises <- c("TAN1702")
class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    CTD_number = as.character(CTD_number),
    Depth = as.character(Depth),
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # keep bar order consistent
  )

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(CTD_number), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "CTD number by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - 1702") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_1702.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")

##

selected_cruises <- c("TAN1702")
desired_day_order <- paste("Day", 1:31)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    Day = gsub("\\s+", " ", trimws(Day)),  # Remove extra spaces
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%
  mutate(
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))
  )


# Step 2: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  deframe()

# Step 2: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 3: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  arrange(Sample_ID) %>%
  deframe()  # named vector: names = Sample_ID, values = Depth

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +  # show Depth instead of Sample_ID
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
   labs(x = "Sampling day by depth (m)") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1702") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selectedSAMPDEPTH_TAN1702.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")
#---------------------------------------------------------------------------------------------------------
# Step 1: Filter and prep the data
selected_cruises <- c("TAN1810")
desired_day_order <- paste("Day", 1:17)

class_df_selected <- class_df_Top12_protist_heter %>%
  filter(Cruise.TAN %in% selected_cruises) %>%
  mutate(
    Day = factor(Day, levels = desired_day_order),
    Depth = as.character(Depth)
  ) %>%
  arrange(Day, Sample_ID) %>%  # arrange by day and then sample
  mutate(
    Sample_ID = factor(Sample_ID, levels = unique(Sample_ID))  # reorder Sample_IDs to reflect Day order
  )

# Step 2: Create depth label vector (named with Sample_ID levels)
depth_labels <- class_df_selected %>%
  distinct(Sample_ID, Depth) %>%
  deframe()

# Step 3: Prepare color palette
color_class_selected <- color_class_heter[names(color_class_heter) %in% unique(class_df_selected$Class)]

# Step 4: Plot
g <- ggplot(data = class_df_selected, aes(x = Sample_ID, y = n_reads, fill = Class)) +
  geom_bar(stat = "identity", position = "fill", width = 0.9) +
  scale_fill_manual(values = color_class_selected) +
  scale_x_discrete(labels = depth_labels) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(cols = vars(Day), scales = "free_x", space = "free_x", switch = "x") +
  labs(x = "Sampling day") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 90, color = "black"),
    axis.text.y = element_text(size = 12),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    strip.text = element_text(size = 12, color = "black", face = "bold"),
    panel.spacing.x = unit(0, "pt"),
    legend.position = "bottom"
  ) +
  ggtitle("Heterotrophic protists - TAN1810") +
  guides(fill = guide_legend(nrow = 2))

# Step 5: Save
ggsave("Top12_protistheter_selected_TAN1810.png", plot = g, width = 12, height = 7, dpi = 300, bg = "white")


```
